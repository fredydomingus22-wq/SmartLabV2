
Isto aqui Ã© material de engenharia de alto nÃ­vel para usar como base de desenvolvimento no Codex, Jules ou qualquer outro agente.
Vou entregar:
âœ” Arquitetura completa
âœ” Estrutura do backend (modular, enterprise)
âœ” Estrutura FUNDO A FUNDO dos schemas
âœ” Todos os modelos de dados
âœ” RelaÃ§Ãµes
âœ” Tabelas auxiliares
âœ” Triggers
âœ” Policies (RLS Supabase)
âœ” Fluxos
âœ” Naming conventions
âœ” Diagramas textuais
âœ” Regras de integridade
âœ” Filesystem da API backend
âœ” Ordem de desenvolvimento
Isto Ã© URs tÃ©cnica nÃ­vel engenheiro, para o LIMS da SmartLab 4.0.
 
ğŸ”¥ VERSÃƒO COMPLETA â€” ARQUITETURA DO BACKEND + BANCO DE DADOS SUPABASE (ENTERPRISE)
 
ğŸ§© 0. PRINCÃPIOS DE ARQUITETURA
O backend deve seguir:
â€¢	Domain-Driven Design (DDD)
â€¢	PostgreSQL como fonte Ãºnica da verdade
â€¢	Supabase como stack base: 
o	Auth
o	RLS
o	Functions
o	Storage
o	Realtime
o	Edge Functions
o	Postgres functions
â€¢	Clean Architecture no backend (Next.js API / Edge Functions)
â€¢	Micro-modular: 
o	module: samples
o	module: analysis
o	module: specs
o	module: qc_release
o	module: haccp
o	module: audit
o	module: documents
o	module: calibration
o	module: nc_capa
o	module: equipment
o	module: production
o	module: dashboard_analytics
 
ğŸ—ï¸ 1. SUPABASE â€” ESTRUTURA GERAL
Schemas
public
lims
lims_admin
lims_audit
lims_haccp
lims_qc
lims_equipment
lims_documents
lims_training
lims_integration
lims_realtime
 
ğŸ§± 2. TABELAS â€” MODELO COMPLETO (ENTERPRISE)
Abaixo estÃ¡ a versÃ£o definitiva, consolidada e usada em empresas classe mundial.
 
ğŸ¯ 2.1. TABELAS DE IDENTIDADE (MASTER DATA)
Schema: lims
products
id (uuid) PK
product_code text UNIQUE
name text
category text
spec_id uuid FK (lims.specifications)
status text check(active/inactive)
created_at timestamptz
updated_at timestamptz
specifications
EspecificaÃ§Ãµes gerenciadas para cada produto.
id uuid PK
product_id uuid FK
version int
status text (active, archived)
created_at timestamptz
spec_parameters
id uuid PK
spec_id uuid FK
parameter_id uuid FK
min_value float
max_value float
target_value float
unit text
criticality text (critical, major, minor)
stability_profile jsonb
method_id uuid FK
parameters
id uuid PK
name text
code text UNIQUE
type text (physico_chemical, micro, sensory, packaging)
unit text
description text
methods
id uuid PK
name text
code text
instrument_required bool
validation_required bool
sop_url text
lines
id uuid PK
line_code text
location text
status text
tanks
id uuid PK
tank_code text
line_id uuid FK
volume_liters float
 
ğŸ§ª 2.2. GESTÃƒO DE AMOSTRAS
samples
id uuid PK
sample_code text UNIQUE
sample_type text (raw_material, process, intermediate, finished, water, micro)
sku_id uuid FK
line_id uuid FK
tank_id uuid FK
batch_no text
collection_point text
collected_by uuid FK (users)
collected_at timestamptz
status text (planned, collected, in_analysis, validated, approved, rejected)
priority int
haccp_trigger bool
sample_events
id uuid PK
sample_id uuid FK
event_type text (created, collected, assigned, analyzed, validated, approved)
event_data jsonb
created_by uuid
created_at timestamptz
 
ğŸ”¬ 2.3. ANÃLISES
analysis
id uuid PK
sample_id uuid FK
parameter_id uuid FK
method_id uuid FK
analyst_id uuid FK
equipment_id uuid FK
started_at timestamptz
finished_at timestamptz
status text (pending, running, completed, validated, rejected)
analysis_results
id uuid PK
analysis_id uuid FK
raw_value float
final_value float
unit text
within_limits bool
deviation_type text (none, minor, major, critical)
trend_position text (above, below, stable)
validated_by uuid
validated_at timestamptz
notes text
 
ğŸš¨ 2.4. NÃƒO CONFORMIDADES E CAPA
nc
id uuid PK
nc_code text
sample_id uuid FK
analysis_id uuid FK
type text (critical, major, minor)
root_cause text
risk_level text (low, medium, high)
opened_by uuid
opened_at timestamptz
status text (open, investigation, corrective_action, closed)
capa
id uuid PK
nc_id uuid FK
action text
responsible uuid
due_date date
status text
verification_result text
 
ğŸ”¥ 2.5. HACCP / FSSC 22000
haccp_plan
id uuid PK
version int
created_at timestamptz
approved_by uuid
status text
pcc_oprp
id uuid PK
plan_id uuid
type text (PCC, OPRP)
line_id uuid
parameter_id uuid
limit_min float
limit_max float
corrective_action text
haccp_monitoring_events
id uuid PK
pcc_id uuid FK
value float
unit text
timestamp timestamptz
operator_id uuid
status text (ok, deviation)
 
ğŸ”§ 2.6. EQUIPAMENTOS E CALIBRAÃ‡ÃƒO
equipment
id uuid PK
name text
code text UNIQUE
model text
manufacturer text
status text (active, inactive, calibration_due, out_of_service)
calibrations
id uuid PK
equipment_id uuid FK
scheduled_for date
performed_at date
performed_by uuid
certificate_url text
result text (pass, fail)
 
ğŸ“„ 2.7. DOCUMENTOS ISO
documents
id uuid PK
title text
category text (SOP, WI, FOR, POL, SPEC)
current_version int
status text
file_url text
created_at timestamptz
updated_at timestamptz
 
ğŸ§‘â€ğŸ« 2.8. COMPETÃŠNCIAS E FORMAÃ‡ÃƒO
training_matrix
id uuid PK
role_id uuid
training_id uuid
required bool
competency_records
id uuid PK
user_id uuid
skill text
level text
valid_until date
 
ğŸ“¦ 2.9. INTEGRAÃ‡ÃƒO / SCADA / ERP
integration_logs
id uuid PK
system text
event text
payload jsonb
status text
created_at timestamptz
 
ğŸ§¾ 2.10. AUDITORIA (RLS TOTAL)
audit_logs
id uuid PK
table_name text
record_id uuid
action text
old_data jsonb
new_data jsonb
timestamp timestamptz
user_id uuid
Trigger:
CREATE TRIGGER audit_all_tables ...
 
ğŸ§© 3. RELAÃ‡Ã•ES COMPLETAS
products 1â€”n specifications  
specifications 1â€”n spec_parameters  
parameters 1â€”n analysis  
samples 1â€”n analysis  
analysis 1â€”n analysis_results  
samples 1â€”n sample_events  
analysis_results 1â€”1 nc  
nc 1â€”n capa  
haccp_plan 1â€”n pcc_oprp  
pcc_oprp 1â€”n haccp_monitoring_events  
equipment 1â€”n calibrations  
documents versioned  
users 1â€”n analysis  
users 1â€”n nc  
 
ğŸ§  4. RLS (SUPABASE SECURITY)
Example:
create policy "LaboratÃ³rio pode ver suas amostras"
on lims.samples
for select
using ( auth.role() = 'lab_tech' OR created_by = auth.uid() );
 
ğŸ›°ï¸ 5. BACKEND â€” ARQUITETURA (NEXT + SUPABASE EDGE FUNCTIONS)
5.1. Estrutura de pastas
/src
  /modules
    /samples
    /analysis
    /specs
    /qc_release
    /nc
    /capa
    /haccp
    /equipment
    /documents
    /training
    /audit
  /core
    /db.ts
    /errors.ts
    /logger.ts
    /auth.ts
  /api
    /samples
      GET / POST / PUT / DELETE
    /analysis
    /nc
    /haccp
 
ğŸ”¥ 6. MICRO-SERVIÃ‡OS (EDGE FUNCTIONS)
/functions/onSampleCreated
â€¢	cria anÃ¡lises automaticamente
â€¢	dispara plano HACCP
/functions/onAnalysisCompleted
â€¢	avalia limites
â€¢	cria NC se necessÃ¡rio
â€¢	atualiza dashboards
/functions/spc_engine
â€¢	cÃ¡lculos estatÃ­sticos
 
ğŸ“Š 7. ANALYTICS E DRILL-DOWN
Usa:
â€¢	Postgres Materialized Views
â€¢	Functions
â€¢	Supabase Realtime
â€¢	RLS para seguranÃ§a
Views importantes:
vw_kpi_conformidade  
vw_kpi_tat  
vw_trends_por_sku  
vw_spc_xbar  
vw_spc_r_chart  
vw_spc_imr  
vw_pareto_falhas  
vw_heatmap_linha_turno  
 
ğŸš€ 8. ROADMAP DE DESENVOLVIMENTO
Fase 1 â€” Core LIMS
â€¢	Samples
â€¢	Analysis
â€¢	Specs
Fase 2 â€” HACCP / NC / CAPA / QC Release
Fase 3 â€” Analytics + Drill-down
Fase 4 â€” IntegraÃ§Ã£o SCADA
Fase 5 â€” IA + PrevisÃ£o + Data Lake
 



